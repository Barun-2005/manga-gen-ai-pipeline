# Manga Generation Pipeline - Centralized Settings
# Phase 18: ComfyUI Integration with New Models

# =============================================================================
# ComfyUI Configuration
# =============================================================================
comfyui:
  # ComfyUI installation path (relative to project root)
  installation_path: "ComfyUI-master"
  
  # ComfyUI server settings
  server:
    url: "${COMFYUI_URL}"  # Use environment variable
    timeout: 300
    max_retries: 3
    retry_delay: 2
  
  # API endpoints
  api:
    prompt: "/prompt"
    queue: "/queue"
    history: "/history"
    view: "/view"
    system_stats: "/system_stats"

# =============================================================================
# Model Configuration - New Anything v4.5 Setup
# =============================================================================
models:
  # Base checkpoint model
  checkpoint:
    name: "anything-v4.5-pruned.safetensors"
    path: "models/checkpoints/anything-v4.5-pruned.safetensors"
    type: "checkpoint"
    
  # VAE model
  vae:
    name: "orangemix.vae.pt"
    path: "models/vae/orangemix.vae.pt"
    type: "vae"
    
  # ControlNet models
  controlnet:
    openpose:
      name: "control_sd15_openpose.pth"
      path: "models/controlnet/control_sd15_openpose.pth"
      type: "controlnet"
      strength: 0.8
    canny:
      name: "control_sd15_canny.pth"
      path: "models/controlnet/control_sd15_canny.pth"
      type: "controlnet"
      strength: 0.8
    depth:
      name: "control_sd15_depth.pth"
      path: "models/controlnet/control_sd15_depth.pth"
      type: "controlnet"
      strength: 0.8
      
  # T2I Adapter models
  t2i_adapter:
    depth:
      name: "t2iadapter_depth_sd15v2.pth"
      path: "models/t2i_adapter/t2iadapter_depth_sd15v2.pth"
      type: "t2i_adapter"
      strength: 0.7
    canny:
      name: "t2iadapter_canny_sd15v2.pth"
      path: "models/t2i_adapter/t2iadapter_canny_sd15v2.pth"
      type: "t2i_adapter"
      strength: 0.7
    sketch:
      name: "t2iadapter_sketch_sd15v2.pth"
      path: "models/t2i_adapter/t2iadapter_sketch_sd15v2.pth"
      type: "t2i_adapter"
      strength: 0.7
      
  # LoRA models
  lora:
    manga_shading:
      name: "manga_shading_lora.safetensors"
      path: "models/loras/manga_shading_lora.safetensors"
      type: "lora"
      strength: 0.8
      
  # IP Adapter models
  ip_adapter:
    face:
      name: "ip-adapter-plus-face_sd15.safetensors"
      path: "models/ipadapter/ip-adapter-plus-face_sd15.safetensors"
      type: "ip_adapter"
      strength: 0.7
      
  # Negative embeddings
  embeddings:
    badhand:
      name: "badhandv4.pt"
      path: "models/embeddings/badhandv4.pt"
      type: "embedding"
    easynegative:
      name: "easynegative.safetensors"
      path: "models/embeddings/easynegative.safetensors"
      type: "embedding"

# =============================================================================
# Workflow Templates
# =============================================================================
workflows:
  # Base workflows
  txt2img:
    template: "assets/workflows/manga_graph.json"
    description: "Basic text-to-image generation"
    
  controlnet:
    template: "assets/workflows/controlnet_workflow.json"
    description: "ControlNet-guided generation"
    
  adapter:
    template: "assets/workflows/adapter_workflow.json"
    description: "T2I Adapter-guided generation"
    
  scene_reference:
    template: "assets/workflows/scene_reference_workflow.json"
    description: "Scene reference workflow"
    
  # Color mode specific workflows
  color_manga:
    template: "assets/workflows/color_manga_workflow.json"
    description: "Full color manga generation"
    
  bw_manga:
    template: "assets/workflows/bw_manga_workflow.json"
    description: "Black and white manga generation"
    
  improved_manga:
    template: "assets/workflows/improved_manga_workflow.json"
    description: "Enhanced manga workflow with LoRA"

# =============================================================================
# Generation Settings
# =============================================================================
generation:
  # Default generation method
  default_method: "txt2img"
  
  # Image dimensions
  dimensions:
    width: 512
    height: 768
    batch_size: 1
    
  # Sampling settings
  sampling:
    steps: 25
    cfg_scale: 7.5
    sampler_name: "dpmpp_2m"
    scheduler: "karras"
    denoise: 1.0
    
  # Seeds
  seed:
    default: -1  # -1 for random
    range: [1, 1000000]
    
  # Fallback settings
  fallback:
    enabled: true
    method: "txt2img"
    
  # Quality settings
  quality:
    enable_hires_fix: false
    upscale_factor: 1.5
    upscale_method: "ESRGAN_4x"

# =============================================================================
# Prompt Configuration
# =============================================================================
prompts:
  # Base prompt files
  base_prompts: "assets/prompts/base_prompts.txt"
  enhanced_prompts: "assets/prompts/enhanced_prompts.txt"
  scene_prompts: "assets/prompts/scene_prompts.txt"
  
  # Negative prompt files
  negatives:
    bad_hand: "assets/negatives/bad_hand_v4.txt"
    easy_negative: "assets/negatives/easy_negative.txt"
    
  # Style prompts
  styles:
    manga_base: "manga style, detailed lineart, high contrast"
    manga_color: "vibrant colors, full color manga style, detailed shading"
    manga_bw: "black and white manga style, high contrast, detailed lineart, screentones"
    
  # Quality enhancers
  quality_positive: "masterpiece, best quality, highly detailed, sharp focus"
  quality_negative: "blurry, low quality, distorted, bad anatomy, worst quality, low quality, normal quality, lowres, bad hands, bad fingers, missing fingers, extra fingers, mutated hands, poorly drawn hands, poorly drawn face, mutation, deformed, ugly, blurry, bad proportions, extra limbs, cloned face, disfigured, out of frame, ugly, extra limbs, bad anatomy, gross proportions, malformed limbs, missing arms, missing legs, extra arms, extra legs, mutated hands, fused fingers, too many fingers, long neck"

# =============================================================================
# Color Mode Configuration
# =============================================================================
color_modes:
  color:
    style_prompt: "vibrant colors, full color manga style, detailed shading"
    negative_prompt: "monochrome, black and white, grayscale"
    workflow_template: "color_manga"
    
  black_and_white:
    style_prompt: "black and white manga style, high contrast, detailed lineart, screentones"
    negative_prompt: "color, colorful, vibrant colors"
    workflow_template: "bw_manga"

# =============================================================================
# Output Configuration
# =============================================================================
output:
  # Directory structure
  directories:
    base: "outputs"
    panels: "panels"
    enhanced: "enhanced"
    validation: "validation"
    metadata: "metadata"
    emotions: "emotions"
    temp: "temp"
    
  # File naming
  naming:
    style: "descriptive"  # descriptive, sequential, timestamp
    include_color_mode: true
    max_filename_length: 100
    
  # Image settings
  image:
    format: "png"
    quality: 95
    create_thumbnails: false
    thumbnail_size: [256, 256]
    
  # Metadata
  metadata:
    save_generation_info: true
    save_workflow: true
    save_prompt_info: true
    
  # Cleanup
  cleanup:
    auto_cleanup: true
    max_saved_runs: 10
    compress_old_runs: false

# =============================================================================
# Reference Images Configuration
# =============================================================================
references:
  # ControlNet reference images
  controlnet:
    openpose: "assets/references/controlnet/scene_pose.png"
    canny: "assets/references/controlnet/scene_canny.png"
    depth: "assets/references/controlnet/scene_depth.png"
    
  # T2I Adapter reference images
  adapter:
    depth: "assets/references/adapter/scene_depth.png"
    canny: "assets/references/adapter/scene_canny.png"
    sketch: "assets/references/adapter/scene_sketch.png"
    
  # Auto-detection settings
  auto_detect:
    enabled: true
    fallback_to_txt2img: true

# =============================================================================
# Validation and Quality Control
# =============================================================================
validation:
  # Emotion extraction
  emotion_extraction:
    enabled: true
    model: "default"
    confidence_threshold: 0.7
    
  # Coherence analysis
  coherence_analysis:
    enabled: true
    check_character_consistency: true
    check_scene_continuity: true
    
  # Dialogue placement
  dialogue_placement:
    enabled: true
    auto_place_bubbles: true
    bubble_style: "manga"
    min_bubble_size: [80, 40]
    max_bubble_size: [300, 150]
    overlap_threshold: 0.3
    placement_quality_threshold: 0.7
    
  # Quality checks
  quality_checks:
    check_image_quality: true
    check_prompt_adherence: true
    save_detailed_reports: true

# =============================================================================
# Story Memory and Continuity
# =============================================================================
story_memory:
  enabled: true
  memory_dir: "outputs/story_memory"
  auto_save_scenes: true
  track_character_arcs: true
  continuity_strength: 0.6

# =============================================================================
# Performance and Optimization
# =============================================================================
performance:
  # Concurrent processing
  max_concurrent_images: 2
  
  # Memory management
  clear_cache_after_generation: true
  max_memory_usage: "8GB"
  
  # Timeouts
  generation_timeout: 300
  api_timeout: 60
  
  # Retry settings
  max_retries: 3
  retry_delay: 2
  exponential_backoff: true

# =============================================================================
# Development and Debug Settings
# =============================================================================
debug:
  enabled: false
  save_intermediate_images: false
  verbose_logging: false
  save_workflow_debug: false
  
# =============================================================================
# Feature Flags
# =============================================================================
features:
  enable_story_generation: true
  enable_image_generation: true
  enable_pdf_compilation: true
  enable_web_interface: false
  enable_advanced_validation: true
  enable_emotion_matching: true
  enable_pose_matching: true

# =============================================================================
# Environment Variables
# =============================================================================
env:
  comfyui_url: "${COMFYUI_URL}"